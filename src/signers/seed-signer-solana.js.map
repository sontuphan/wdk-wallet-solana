{"version":3,"sources":["seed-signer-solana.ts"],"sourcesContent":["\"use strict\";\n\nimport { NotImplementedError } from \"@tetherto/wdk-wallet\";\nimport * as bip39 from \"bip39\";\nimport HDKey from \"micro-key-producer/slip10.js\";\nimport { verifySignature, signBytes, SignatureBytes } from \"@solana/keys\";\nimport {\n  createKeyPairSignerFromPrivateKeyBytes,\n  KeyPairSigner,\n  setTransactionMessageFeePayerSigner,\n  signTransactionMessageWithSigners,\n} from \"@solana/signers\";\nimport {\n  getBase64EncodedWireTransaction,\n  getTransactionDecoder,\n} from \"@solana/transactions\";\nimport {\n  decompileTransactionMessage,\n  getCompiledTransactionMessageDecoder,\n} from \"@solana/transaction-messages\";\n\n// eslint-disable-next-line camelcase\nimport { sodium_memzero } from \"sodium-universal\";\n\n/** @typedef {import('@tetherto/wdk-wallet').KeyPair} KeyPair */\n\nconst BIP_44_SOL_DERIVATION_PATH_PREFIX = \"m/44'/501'\";\n\nexport class ISignerSolana {\n  /**\n   * The flag indicates whether the signer is ready to use.\n   *\n   * @type {boolean}\n   */\n  get isActive() {\n    throw new NotImplementedError(\"isActive\");\n  }\n\n  /**\n   * The derivation path's index of this account.\n   *\n   * @type {number}\n   */\n  get index() {\n    throw new NotImplementedError(\"index\");\n  }\n\n  /**\n   * The derivation path of this account.\n   *\n   * @type {string}\n   */\n  get path() {\n    throw new NotImplementedError(\"path\");\n  }\n\n  /**\n   * The signer config.\n   *\n   * @type {object}\n   */\n  get config() {\n    throw new NotImplementedError(\"config\");\n  }\n\n  /**\n   * The account address.\n   *\n   * @type {string}\n   */\n  get address() {\n    throw new NotImplementedError(\"address\");\n  }\n\n  /**\n   * The account's key pair.\n   *\n   * Returns the raw key pair bytes in standard Solana format.\n   * - privateKey: 32-byte Ed25519 secret key (Uint8Array)\n   * - publicKey: 32-byte Ed25519 public key (Uint8Array)\n   *\n   * @type {KeyPair}\n   */\n  get keyPair() {\n    throw new NotImplementedError(\"keyPair\");\n  }\n\n  /**\n   * Derive a child account.\n   *\n   * @param {string} relPath - The relative path.\n   * @param {object} config - The config.\n   * @returns {SeedSignerSolana} The child instance of SeedSignerSolana.\n   */\n  derive(relPath: string, cfg = {}) {\n    throw new NotImplementedError(\"derive(relPath, cfg = {})\");\n  }\n\n  /**\n   * Signs a message.\n   *\n   * @param {string} message - The message to sign.\n   * @returns {Promise<string>} The message's signature.\n   */\n  async sign(message: string) {\n    throw new NotImplementedError(\"sign(message)\");\n  }\n\n  /**\n   * Verifies a message's signature.\n   *\n   * @param {string} message - The original message.\n   * @param {string} signature - The signature to verify.\n   * @returns {Promise<boolean>} True if the signature is valid.\n   */\n  async verify(message: string, signature: string) {\n    throw new NotImplementedError(\"verify(message, signature)\");\n  }\n\n  /**\n   * Sign a transaction\n   *\n   * @param {Uint8Array} unsignedTx - The unsigned transaction.\n   * @returns {Promise<Uint8Array>} The signed transaction.\n   */\n  async signTransaction(unsignedTx: Uint8Array) {\n    throw new NotImplementedError(\"signTransaction(unsignedTx)\");\n  }\n\n  /**\n   * Disposes the wallet account, erasing the private key from the memory.\n   */\n  dispose() {\n    throw new NotImplementedError(\"dispose()\");\n  }\n}\n\n/**\n * @implements {ISignerSolana}\n */\nexport default class SeedSignerSolana {\n  private _config: Record<string, any>;\n  private _isRoot: boolean;\n  private _root: HDKey;\n  private _account: KeyPairSigner<string>;\n  private _address: string;\n  private _path: string;\n  private _isActive: boolean;\n  private _rawPublicKey: Uint8Array;\n  private _rawPrivateKey: Uint8Array;\n\n  constructor(\n    seed: string | Buffer | Uint8Array,\n    config = {},\n    opts: { path?: string; root?: HDKey } = {}\n  ) {\n    if (opts.root && seed) {\n      throw new Error(\"Provide either a seed or a root, not both.\");\n    }\n\n    if (!opts.root && !seed) {\n      throw new Error(\"Seed or root is required.\");\n    }\n\n    if (typeof seed === \"string\") {\n      if (!bip39.validateMnemonic(seed)) {\n        throw new Error(\"The seed phrase is invalid.\");\n      }\n      seed = bip39.mnemonicToSeedSync(seed);\n    }\n\n    this._config = config;\n    this._isRoot = true;\n    this._root =\n      opts.root ||\n      (seed\n        ? HDKey.fromMasterSeed(seed).derive(BIP_44_SOL_DERIVATION_PATH_PREFIX)\n        : undefined);\n    this._account = undefined;\n    this._address = undefined;\n    this._path = undefined;\n    this._isActive = false;\n\n    if (opts.path) {\n      this._initAccount(this._root, opts.path); // This is an async process, which requires checking `isActive` to ensure the complete construction.\n      this._path = `${BIP_44_SOL_DERIVATION_PATH_PREFIX}/${opts.path}`;\n      this._isRoot = false;\n    }\n\n    /**\n     * Raw Ed25519 public key bytes (32 bytes).\n     *\n     * @private\n     * @type {Uint8Array | undefined}\n     */\n    this._rawPublicKey = undefined;\n\n    /**\n     * Raw Ed25519 private key bytes (32 bytes).\n     *\n     * @private\n     * @type {Uint8Array | undefined}\n     */\n    this._rawPrivateKey = undefined;\n  }\n\n  private async _initAccount(root: HDKey, relPath: string) {\n    const { privateKey } = root.derive(`m/${relPath}`, true);\n\n    const account = await createKeyPairSignerFromPrivateKeyBytes(privateKey);\n\n    this._account = account;\n    this._address = this._account.address;\n    this._isActive = true;\n\n    const publicKey = await crypto.subtle.exportKey(\n      \"raw\",\n      account.keyPair.publicKey\n    );\n\n    this._rawPublicKey = new Uint8Array(publicKey);\n    this._rawPrivateKey = new Uint8Array(privateKey);\n\n    sodium_memzero(privateKey);\n  }\n\n  get isActive() {\n    return this._isActive;\n  }\n\n  get isRoot() {\n    return this._isRoot;\n  }\n\n  get index() {\n    const segments = this.path.split(\"/\");\n    return +segments[3].replace(\"'\", \"\");\n  }\n\n  get path() {\n    return this._path;\n  }\n\n  get address() {\n    return this._address;\n  }\n\n  get keyPair() {\n    return {\n      privateKey: this._rawPrivateKey,\n      publicKey: this._rawPublicKey,\n    };\n  }\n\n  derive(relPath: string, config: Record<string, any> = {}) {\n    const merged = {\n      ...this._config,\n      ...Object.fromEntries(\n        Object.entries(config || {}).filter(([, v]) => v !== undefined)\n      ),\n    };\n    return new SeedSignerSolana(null, merged, {\n      root: this._root,\n      path: relPath,\n    });\n  }\n\n  async sign(message: string) {\n    if (!this._account) {\n      throw new Error(\"The wallet account has been disposed.\");\n    }\n    const messageBytes = Buffer.from(message, \"utf8\");\n    const signatureBytes = await signBytes(\n      this._account.keyPair.privateKey,\n      messageBytes\n    );\n    const signature = Buffer.from(signatureBytes).toString(\"hex\");\n\n    return signature;\n  }\n\n  async verify(message: string, signature: string) {\n    const messageBytes = Buffer.from(message, \"utf8\");\n    const signatureBytes = Buffer.from(signature, \"hex\");\n\n    const isValid = await verifySignature(\n      this._account.keyPair.publicKey,\n      signatureBytes as unknown as SignatureBytes,\n      messageBytes\n    );\n\n    return isValid;\n  }\n\n  async signTransaction(unsignedTx: Uint8Array | Buffer) {\n    if (!this._account) {\n      throw new Error(\n        \"Cannot sign transactions from a root signer. Derive a child first.\"\n      );\n    }\n\n    const tx = getTransactionDecoder().decode(unsignedTx);\n    const compiledTransactionMessage =\n      getCompiledTransactionMessageDecoder().decode(tx.messageBytes);\n    const readonlyTransactionMessage = decompileTransactionMessage(\n      compiledTransactionMessage\n    );\n    const transactionMessage = setTransactionMessageFeePayerSigner(\n      this._account,\n      readonlyTransactionMessage\n    );\n    const signedTransaction = await signTransactionMessageWithSigners(\n      transactionMessage\n    );\n\n    return Buffer.from(\n      getBase64EncodedWireTransaction(signedTransaction),\n      \"base64\"\n    );\n  }\n\n  dispose() {\n    sodium_memzero(this._rawPrivateKey);\n    this._root = undefined;\n    this._account = undefined;\n    this._address = undefined;\n    this._path = undefined;\n    this._isActive = false;\n  }\n}\n"],"mappings":"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","names":[]}